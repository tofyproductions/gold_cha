<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>转专  - 驻住 专砖</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Rubik', sans-serif;
      background: linear-gradient(to bottom, #fff8e7, #ffffff);
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 640px;
      margin: auto;
      background: #ffffff;
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
    }
    h1 {
      text-align: center;
      color: #d4af37;
      font-size: 2em;
      margin: 0 0 20px;
    }
    .field { margin: 12px 0 0; }
    label {
      display: block;
      margin: 0 0 6px;
      font-weight: 600;
    }
    input, select, button {
      font-family: inherit;
      font-size: 1em;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
    }
    input:invalid { border-color: #d26767; }
    .helper {
      font-size: .85em;
      color: #666;
      margin-top: 4px;
    }
    .checkbox-group {
      margin-top: 16px;
      display: grid;
      gap: 10px;
    }
    .checkbox {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      background: #fffefb;
      padding: 10px;
      border: 1px solid #d4af37;
      border-radius: 10px;
      font-size: 0.95em;
      line-height: 1.4em;
    }
    .checkbox input[type="checkbox"] {
      accent-color: #d4af37;
      width: 18px;
      height: 18px;
      margin-top: 2px;
      flex-shrink: 0;
    }
    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      background-color: #d4af37;
      border: none;
      color: white;
      font-size: 1.15em;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .04s ease;
    }
    button:active { transform: translateY(1px); }
    button:disabled {
      background-color: #bba254;
      cursor: not-allowed;
      opacity: .85;
    }
    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #d4af37;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.05em;
      display: none;
      z-index: 9999;
    }
    .sr-only {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;
    }
    @media (max-width: 600px) {
      .container { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>驻住 专砖 - 转专 </h1>

    <form id="goldenForm" novalidate>
      <!-- 砖 驻专 -->
      <div class="field">
        <label for="firstName">砖 驻专</label>
        <input type="text" id="firstName" name="firstName" autocomplete="given-name" required>
      </div>

      <!-- 砖 砖驻 -->
      <div class="field">
        <label for="lastName">砖 砖驻</label>
        <input type="text" id="lastName" name="lastName" autocomplete="family-name" required>
      </div>

      <!-- 驻 -->
      <div class="field">
        <label for="phone">住驻专 驻驻</label>
        <input
          type="tel"
          id="phone"
          name="phone"
          inputmode="numeric"
          autocomplete="tel-national"
          placeholder="050-1234567"
          pattern="0[2-9][0-9]-?[0-9]{7}"
          required
          aria-describedby="phoneHelp"
        >
        <div id="phoneHelp" class="helper">: 050-1234567. 砖  住驻专 砖专  10 住驻专转.</div>
      </div>

      <!-- 注专 -->
      <div class="field">
        <label for="city">注专 专</label>
        <input type="text" id="city" name="city" autocomplete="address-level2" required>
      </div>

      <!-- 转专  -->
      <div class="field">
        <label for="dob">转专 </label>
        <input type="date" id="dob" name="dob" required>
      </div>

      <!-- 砖专 -->
      <div class="checkbox-group">
        <label class="checkbox" for="agree1">
          <input type="checkbox" id="agree1" required>
          砖专 专砖 注 拽转 "专 砖 驻" 拽转 注转 注
        </label>
        <label class="checkbox" for="agree2">
          <input type="checkbox" id="agree2" required>
          住驻专 砖转转驻  转  驻注转 转. 转 砖拽 专砖  住驻拽 砖转转祝 住专转   驻注转 .
        </label>
      </div>

      <button type="submit" id="submitBtn">砖</button>
      <div class="sr-only" aria-live="polite" id="liveRegion"></div>
    </form>
  </div>

  <div class="popup" id="popupMsg">转! 专砖 转拽 - 转专 转专  </div>

  <script>
    // ----- 拽驻专爪 -----
    const config = {
      prod: {
        eventSheet: 'https://api.sheetbest.com/sheets/8b8d86e8-2a58-42d5-a4f9-b7432569d721',
        masterSheet: 'https://api.sheetbest.com/sheets/6fa4234d-1425-4ad4-8a46-508f2eae5ff6'
      },
      use: 'prod'
    };

    // -----  -----
    const form = document.getElementById('goldenForm');
    const submitBtn = document.getElementById('submitBtn');
    const popupMsg = document.getElementById('popupMsg');
    const phoneInput = document.getElementById('phone');
    const agree1 = document.getElementById('agree1');
    const agree2 = document.getElementById('agree2');
    const liveRegion = document.getElementById('liveRegion');

    // ----- 砖专转 -----
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // 转爪 注 拽祝,  砖专 转  拽祝
    const formatPhoneForView = (digits) => {
      const d = digits.replace(/\D/g, '').slice(0, 10);
      if (d.length <= 3) return d;
      return d.slice(0, 3) + '-' + d.slice(3);
    };
    const normalizePhoneForSave = (value) => value.replace(/\D/g, ''); // "0501234567"

    // 爪转 驻住 转转
    const setCheckboxValidity = () => {
      const ok = agree1.checked && agree2.checked;
      agree1.setCustomValidity(ok ? '' : '砖 砖专 转 砖转 转转');
      agree2.setCustomValidity(ok ? '' : '砖 砖专 转 砖转 转转');
    };

    phoneInput.addEventListener('input', () => {
      phoneInput.value = formatPhoneForView(phoneInput.value);
    });
    agree1.addEventListener('change', setCheckboxValidity);
    agree2.addEventListener('change', setCheckboxValidity);

    // 注转 砖 驻
    let inFlight = false;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setCheckboxValidity();

      //  砖 砖转  转拽 - 转 驻驻 砖
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      if (inFlight) return;
      inFlight = true;
      submitBtn.disabled = true;

      const timestamp = new Date().toISOString();
      // 拽转 
const birthDate = new Date(form.dob.value);
const today = new Date();
const age = today.getFullYear() - birthDate.getFullYear();
const monthDiff = today.getMonth() - birthDate.getMonth();
const dayDiff = today.getDate() - birthDate.getDate();
const isUnder14 = age < 14 || (age === 14 && (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)));

if (isUnder14) {
  alert('专砖 转专转  14 注 .');
  submitBtn.disabled = false;
  inFlight = false;
  return;
}
      const phoneDigits = normalizePhoneForSave(phoneInput.value);
      const payload = {
        timestamp,
        firstName: form.firstName.value.trim(),
        lastName: form.lastName.value.trim(),
        phone: phoneDigits,            // 砖专  拽驻
        city: form.city.value.trim(),
        dateOfBirth: form.dob.value,   // YYYY-MM-DD
        confirmation: '锔锔'
      };

      try {
        const { eventSheet, masterSheet } = config[config.use];

        // 拽转 驻转 - 住住转 驻 专
        const eventData = await fetch(eventSheet, { cache: 'no-store' }).then(r => r.json());
        const isDup = eventData.some(row => String(row.phone || '').replace(/\D/g, '') === phoneDigits);
        if (isDup) {
          alert('住驻专 驻  专 专砖.  转 专砖 驻注 专注.');
          return;
        }

        // 砖专 专注
        await fetch(eventSheet, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // 住驻  专转  注  拽
        const masterData = await fetch(masterSheet, { cache: 'no-store' }).then(r => r.json());
        const existsInMaster = masterData.some(row => String(row.phone || '').replace(/\D/g, '') === phoneDigits);
        if (!existsInMaster) {
          await fetch(masterSheet, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }

        // 爪 - 驻住 转爪转
        form.reset();
        phoneInput.value = ''; // 砖 砖专 拽祝
        popupMsg.style.display = 'block';
        liveRegion.textContent = '专砖 拽 爪';
        await sleep(2800);
        popupMsg.style.display = 'none';
      } catch (err) {
        console.error(err);
        alert('专注 砖 砖. 住 砖.');
      } finally {
        submitBtn.disabled = false;
        inFlight = false;
      }
    });
  </script>
</body>
</html>
